/*!
 Data.js - v0.2.0 | Build Date: 2013-10-12 
 (c) 2013 Matt Malone | https://raw.github.com/MentalAtom/Data.js/master/LICENSE
*/
"object"!=typeof data&&(data={}),function(){"use strict";data.extendObject=function(a,b){var c,d=Object.prototype.hasOwnProperty;for(c in b)d.call(b,c)&&(a[c]=b[c]);return a},data.createClass=function(a,b){function c(){}function d(){this.init.apply(this,arguments)}return b||(b=a,a={}),c.prototype=a.prototype,d.prototype=new c,d.parent=a.prototype,data.extendObject(d.prototype,b),d}}(),function(){"use strict";void 0===Array.prototype.indexOf&&(Array.prototype.indexOf=function(a){var b;for(b in this)if(this[b]===a)return b;return-1}),"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")})}(),function(a){a.load=function(b,c){c||(c={});var d,e,f=new XMLHttpRequest,g={type:"GET",data:""};c=a.extendObject(c,g),window.XDomainRequest?(e=function(){c.callback(d.responseText)},d=new XDomainRequest,d.open(c.type,b),d.onload=e,d.send(JSON.stringify(c.data))):(e=function(){c.callback(f.responseText)},f.open(c.type,b),f.onload=e,f.send(JSON.stringify(c.data)))},a.forEach=function(a,b){var c,d=Object.prototype.hasOwnProperty;for(c in a)d.call(a,c)&&b(c,a[c])},a.forEachDeep=function(a,b){var c,d;Object.prototype.hasOwnProperty;for(c in a)for(d in a[c])b(c,d,a[c][d])}}(data),function(){"use strict";data.CSVtoJSON=function(a,b){b||(b=","),","!==b&&(a=a.replace(b,",")),a=a.replace(/,(?=\n\r|\n|\r)/g,"");var c,d,e=a.split(/\n(?![\w]+["])/g),f=e[0].split(/(?!"),(?![\w]+["])/g),g=new data.CSVObject;return f.length,f=g.setColumns(f),e.splice(0,1),data.forEach(e,function(a,b){c=b.split(/(?!"),(?![\w]+["])/g),d={},data.forEach(c,function(a,b){d[f[a]]=b.replace(/(?=[\w]*)"(?!")/g,""),/^[\-]?[0-9]+[\.]?[0-9]*$/g.test(d[f[a]])&&(d[f[a]]=data.parseNum(d[f[a]]))}),g.push(d)}),g},data.JSONtoCSV=function(a){for(var b=[],c=[],d=0;d<a.length;d+=1)data.forEach(a[d],function(a){b.indexOf(a)<0&&b.push(a)}),c.push(data.delimit(a[d])+"\n");return c.unshift(data.delimit(b)+"\n"),c.join("")},data.delimit=function(a){var b="";return data.forEach(a,function(a,c){if("string"!=typeof c&&(c=c.toString()),c.match(/["\n,]/g)){var d=c.replace(/"/g,'""');b+='"'+d+'",'}else b+=c+","}),b=b.replace(/(\r\n|\n|\r)/gm,"")},data.countRows=function(a,b){void 0===b&&(b=!1);var c=a.split(/\n(?![\w]+["])/g).length;return b||(c-=1),c},data.isValidCSV=function(a){a=a.replace(/,(?=\n\r|\n|\r)/g,""),console.log(a);var b,c=a.split(/\n(?![\w]+["])/g),d=c[0].split(/(?!"),(?![\w]+["])/g).length,e=!0;return c.splice(0,1),data.forEach(c,function(a,f){b=f.split(/(?!"),(?![\w]+["])/g).length,b!==d&&a!==c.length&&""!==f&&a!==c.length-1&&(e=!1)}),e},data.CSVrowsWhere=function(a,b){var c,d=new data.CSVMatcher(a,b);return c=d.rows},data.drawAsTable=function(a){var b,c=document.createElement("table"),d=document.createElement("tbody"),e=document.createElement("thead"),f=0;for(e.insertRow(0),b=0;b<a.columns.length;b+=1)e.rows[0].appendChild(document.createElement("th")),e.rows[0].childNodes[b].appendChild(document.createTextNode(a.columns[b]));return data.forEach(a.rows,function(a,b){d.insertRow(a),data.forEach(b,function(b,c){d.rows[a].insertCell(),d.rows[a].cells[0].appendChild(document.createTextNode(c)),f+=1})}),c.appendChild(e),c.appendChild(d),document.getElementsByTagName("body")[0].appendChild(c),c},data.CSVfromTable=function(a){var b,c=a.getElementsByTagName("thead")[0],d=a.getElementsByTagName("tbody")[0],e=c.getElementsByTagName("th"),f=d.getElementsByTagName("tr"),g=(Object.prototype.hasOwnProperty,{columns:[],rows:[]}),h=0,i=new data.CSVObject;return data.forEach(e,function(a,b){1===b.nodeType&&g.columns.push(b.innerHTML)}),data.forEach(f,function(a,c){1===c.nodeType&&(b={},data.forEach(c.childNodes,function(a,c){1===c.nodeType&&"td"===c.tagName.toLowerCase()&&(b[g.columns[h]]=c.innerHTML,h+=1)})),i.push(b),h=0}),i.setColumns(g.columns),i},data.parseNum=function(a){return isNaN(parseFloat(a,10))?a:parseFloat(a,10)}}(data),data.CSVMatcher=function(){"use strict";var a={types:["equals","morethan","lessthan","notequal","contains"],equals:{discover:/[\w\s]*\s(?=equals|[\=]{1,3}(?!=))/,delimeter:/\s[\=]{1,3}(?!=)/,delimitMatch:/\s[\=]{1,3}/g,delimitFalse:"equals"},morethan:{discover:/[\w\s]*\s(?=greater than|[\>?]{1}(?=\s))/,delimeter:/\s[\>]{1}(?=\s)/,delimitMatch:/\s[\>]{1}/g,delimitFalse:"greater than"},lessthan:{discover:/[\w\s]*\s(?=less than|[\\<]{1}(?=\s))/,delimeter:/\s[\\<]{1}(?=\s)/,delimitMatch:/\s[\\<]{1}/g,delimitFalse:"less than"},notequal:{discover:/[\w\s]*\s(?=not equal to|[\!]{1}[\=]{2}(?=\s))/,delimeter:/\s[!]{1}[=]{2}(?=[\s])/,delimitMatch:/\s[!]{1}[=]{2}/g,delimitFalse:"not equal to"},contains:{discover:/[\w\s]*\s(?=contains)/g,delimeter:/\s(?=contains\s)/,delimitMatch:/\scontains\s/g}};return new data.createClass({init:function(a,b){this.CSVData=a,this.testString=b,this.matchers={},this.rows=[],"object"!=typeof this.CSVData&&(data.isValidCSV(this.CSVData),this.CSVData=data.CSVtoJSON(this.CSVData)),this.findCombo(),1===this.combos.length?(this.discoverType(),this.findDelimeter(),this.findQueryParts(),this.addMatchers(),this.doMatch()):this.processMultiple()},discoverType:function(){var b,c=this;if(data.forEach(a.types,function(d,e){a[e].discover.test(c.testString)&&(c.testType=b=e)}),!b)throw new Error("No valid match expression found: "+c.testString);return b},findDelimeter:function(){var b=a[this.testType].delimeter.test(this.testString),c=a[this.testType];if(b)this.delimeter=c.delimitMatch instanceof RegExp?this.testString.match(c.delimitMatch)[0]:c.delimitMatch;else{if(!(this.testString.indexOf(c.delimitFalse)>-1))throw new Error("No valid delimeter found in match expression.\n (If you're seeing this error, I messed up somwehere)");this.delimeter=c.delimitFalse}return this.delimeter=this.delimeter.trim(),this.delimeter},findQueryParts:function(){var b,c,d=this.delimeter,e=this.testString;return a[this.testType],b=e.substring(0,e.indexOf(d)-1).trim(),c=e.substring(e.indexOf(d)+d.length+1,e.length).trim(),this.queryParts=[b,c],[b,c]},doMatch:function(){var a,b=this.matchers[this.testType];if(void 0!==b)return a=this[b].apply(this,this.queryParts);throw new TypeError("No match function found for type "+this.testType)},addMatchers:function(a){var b,c;Object.prototype.hasOwnProperty,a||(a=this),this.matchers||(this.matchers={});for(b in a)c=b.match(/[\w]*(?=Matcher)/),c&&c.length>0&&(this.matchers[c[0]]=b);return delete this.matchers.add,this.matchers},equalsMatcher:function(a,b){return this.performBasicMatch("=",a,b),this.rows},morethanMatcher:function(a,b){return this.performBasicMatch(">",a,b),this.rows},lessthanMatcher:function(a,b){return this.performBasicMatch("<",a,b),this.rows},notequalMatcher:function(a,b){return this.performBasicMatch("!=",a,b),this.rows},containsMatcher:function(a,b){var c=this;data.forEachDeep(this.CSVData,function(d,e,f){f=f.toString().trim(),e=e.trim(),e===a&&f.indexOf(b)>-1&&c.rows.push(c.CSVData[d])})},performBasicMatch:function(a,b,c){var d=[">","<","=","!="],e=this;if(!(d.indexOf(a)>-1))throw new Error("A basic match cannot be performed for "+a);return data.forEachDeep(this.CSVData,function(d,f,g){if(g=g.toString().trim(),f=f.trim(),f===b)switch(a){case">":parseInt(g,10)>parseInt(c,10)&&e.rows.push(e.CSVData[d]);break;case"<":parseInt(g,10)<parseInt(c,10)&&e.rows.push(e.CSVData[d]);break;case"=":g===c&&e.rows.push(e.CSVData[d]);break;case"!=":g!==c&&e.rows.push(e.CSVData[d])}}),e.rows},findCombo:function(){var a=this;return this.combos=this.testString.split(/(\sand\s|\s[&]{2}(?!&)\s)/g),data.forEach(this.combos,function(b,c){/(and|[&]{2})/g.test(c)&&a.combos.splice(b,1)}),this.combos},processMultiple:function(){var a=new data.CSVMatcher(this.CSVData,this.combos[0]);this.combos.splice(0,1),data.forEach(this.combos,function(b,c){a=new data.CSVMatcher(a.rows,c)}),this.rows=a.rows}})}(),data.CSVObject=function(){"use strict";return data.createClass({init:function(){this.rowCount=null,this.columns=[],this.rows=[]},push:function(a){Array.prototype.push.call(this.rows,a),this.rowCount+=1},where:function(a){var b=new data.CSVMatcher(this.rows,a),c=new data.CSVObject;return c.setColumns(this.columns),data.forEach(b.rows,function(a,b){c.push(b)}),c},setColumns:function(a){var b=this;return this.columns||(this.columns=[]),data.forEach(a,function(a,c){b.columns.push(c.trim())}),this.columns},get:function(a){var b=[];return data.forEachDeep(this.rows,function(c,d,e){d===a&&b.push(e)}),1===b.length&&(b=b[0]),b},toCSV:function(){return data.JSONtoCSV(this.rows)}})}(),function(a){a.getRootElementName=function(a){var b;for(b in a.childNodes)if(1===a.childNodes[b].nodeType)return a.childNodes[b].tagName;throw new Error("Could not find root element")},a.countChildNodes=function(b){var c,d=0,e=a.getRootElementName(b),f=b.getElementsByTagName(e)[0].childNodes;for(c in f)f[c].nodeType&&3!==f[c].nodeType&&(d+=1);return d},a.JSONtoXML=function(b,c){var d={rootTagName:"JSON"};c||(c=d.rootTagName);var e,f=document.implementation.createDocument(null,null,null);e=document.createElement(c),f.appendChild(e),a.forEach(b,function(a,b){var c=document.createElement(a);c.innerHTML=b,e.appendChild(c)}),console.log(f)}}(data);